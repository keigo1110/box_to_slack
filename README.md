# ESP32 Document Submission Detector

ESP32とSW-520D傾斜センサーを使用して、書類の提出を検知しSlackに通知するシステムです。OTA更新機能やエラー処理機能を備えた堅牢な設計となっています。

## 概要
書類提出トレイに傾斜センサーを設置し、書類が投函された際の傾きを検知して、Slackワークスペースに通知を送信します。システムは安定性を重視し、誤検知防止やエラーハンドリング、自動復旧機能を実装しています。

## 必要なハードウェア
- ESP32開発ボード
- SW-520D 傾斜センサー
- LED（ステータス表示用）
- ブレッドボードと配線材

## 必要なライブラリ
- WiFi.h (ESP32標準ライブラリ)
- HTTPClient.h (ESP32標準ライブラリ)
- ArduinoJson.h
- ESPmDNS.h
- WiFiUDP.h
- ArduinoOTA.h
- TimeLib.h

## セットアップ手順
1. Arduino IDEに ESP32 ボードマネージャを追加
2. 必要なライブラリをインストール
3. プログラム内の以下の設定を環境に合わせて変更:
   ```cpp
   const char* ssid = "write your ssid";
   const char* password = "write your password";
   const char* slackWebhookUrl = "write your slack webhook url";
   const char* DEVICE_NAME = "TiltSensor";
   const char* OTA_PASSWORD = "admin";
   ```
4. SW-520D傾斜センサーをGPIO 10に接続
5. ステータスLEDをGPIO 2に接続

## 主な機能
- 高度なデバウンス処理による誤検知防止
  - サンプリング間隔: 100ms
  - 安定検出時間: 2秒
  - 30サンプル中25回以上の傾き検出で傾きと判定
- WiFi接続の自動管理
  - 接続断時の自動リトライ（最大5回）
  - 接続状態のLED表示
- エラー処理と自動復旧
  - 各種エラーの検出と記録
  - エラー発生時のSlack通知
  - エラー回数超過時の自動再起動
- Over The Air (OTA) アップデート機能
- 定期的なヘルスチェック（24時間間隔）
  - システム稼働時間
  - WiFi信号強度
  - エラー発生状況
- Slack通知機能
  - メッセージ送信の自動リトライ
  - 通知の重複防止（20秒間のインターバル制御）

## LED表示の意味
- 点灯: WiFi接続済み
- 点滅: WiFi接続中
- 消灯: WiFi未接続

## エラー処理
システムは以下のエラーを監視・対応します：
- WiFi接続エラー
- HTTP通信エラー
- センサーエラー
- 設定エラー

エラー発生時は：
1. エラーをSlackに通知
2. エラーカウンターをインクリメント
3. 一定時間後にエラーカウンターをリセット
4. エラー回数が上限（5回）を超えた場合は自動再起動

## トラブルシューティング
- WiFi接続が不安定な場合
  - WiFi信号強度を確認（-80dBm以上推奨）
  - アンテナの位置や向きを調整
- 誤検知が多い場合
  - センサーの取り付け角度を調整
  - `TILT_THRESHOLD`の値を調整（デフォルト: 25/30）
- システムが応答しない場合
  - セーフモードでの起動を確認
  - エラーログをシリアルモニタで確認

## 開発者向け情報
- シリアル通信速度: 115200bps
- メインループの遅延時間: 10ms
- システム状態の監視と表示機能あり
  - `printSystemStatus()`で現在の状態を確認可能
  - `isSystemHealthy()`でシステムの健全性をチェック可能

## 注意事項
- OTAパスワードは必ず変更してください
- Slack Webhook URLは適切に管理してください
- システムの安定性のため、電源は安定した供給源を使用してください
